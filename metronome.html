<!--
a metronome app that can be used to practice playing an instrument.
with a simple interface include play/stop button, and a slider for bpm (the bpm should be adjustable), default at 60.
the metronome should be able to play in the background, and the page should be able to be closed.
-->
<!DOCTYPE html>
<html>

<head>
    <title>Metronome</title>
</head>
<style>
    body {
        background-color: #f2f2f2;
    }

    h1 {
        text-align: center;
    }

    p {
        text-align: center;
    }

    button {
        background-color: #4CAF50;
        /* Green */
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
    }

    .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 25px;
        background: #d3d3d3;
        outline: none;
        opacity: 0.7;
        -webkit-transition: .2s;
        transition: opacity .2s;
    }

    .slider:hover {
        opacity: 1;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        background: #4CAF50;
        cursor: pointer;
    }

    .slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        background: #4CAF50;
        cursor: pointer;
    }
</style>

<body>
    <h1>Metronome</h1>
    <p>Click the button to start the metronome.</p>
    <button onclick="startMetronome()">Start</button>
    <button onclick="stopMetronome()">Stop</button>
    <!-- slider for bpm that changes t-->
    <p>Adjust the bpm.</p>
    <input type="range" min="40" max="200" value="60" class="slider" id="bpm" oninput="adjustBpm()">
    <p id="demo"></p>
    <script>
        var audioContext = new AudioContext();
        var oscillator = audioContext.createOscillator();
        var gainNode = audioContext.createGain();
        var isPlaying = false;
        var startTime;
        var current16thNote;
        var tempo = 60.0; // tempo (in beats per minute)
        var lookahead = 25.0; // How frequently to call scheduling function (in milliseconds)
        var scheduleAheadTime = 0.1; // How far ahead to schedule audio (sec)
        // This is calculated from lookahead, and overlaps
        // with next interval (in case the timer is late)
        var nextNoteTime = 0.0; // when the next note is due.
        var noteResolution = 0; // 0 == 16th, 1 == 8th, 2 == quarter note
        var noteLength = 0.05; // length of "beep" (in seconds)
        var timerID = 0; // setInterval identifier.
        var notesInQueue = []; // the notes that have been put into the web audio,
        // and may or may not have played yet. {note, time}
        var noteResolution = 0; // 0 == 16th, 1 == 8th, 2 == quarter note
        var noteLength = 0.05; // length of "beep" (in seconds)
        var timerID = 0; // setInterval identifier.
        var notesInQueue = []; // the notes that have been put into the web audio,
        // and may or may not have played yet. {note, time}
        function nextNote() {
            // Advance current note and time by a 16th note...
            var secondsPerBeat = 60.0 / tempo; // Notice this picks up the CURRENT
            // tempo value to calculate beat length.
            nextNoteTime += 0.25 * secondsPerBeat; // Add beat length to last beat time
            current16thNote++; // Advance the beat number, wrap to zero
            if (current16thNote == 16) {
                current16thNote = 0;
            }
        }

        function scheduleNote() {
            // push the note on the queue, even if we're not playing.
            notesInQueue.push({
                note: current16thNote,
                time: nextNoteTime
            });
            // create an oscillator
            oscillator = audioContext.createOscillator();
            gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            if (noteResolution == 1) // we're not playing non-16th 16th notes
                oscillator.frequency.value = 880.0;
            else // we're playing 16th 16th notes
                if (current16thNote % 4) // not on the beat
                    oscillator.frequency.value = 440.0;
                else // on the beat
                    oscillator.frequency.value = 880.0;
            oscillator.start(nextNoteTime);
            oscillator.stop(nextNoteTime + noteLength);
        }

        function scheduler() {
            // while there are notes that will need to play before the next interval,
            // schedule them and advance the pointer.
            while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
                scheduleNote();
                nextNote();
            }
            timerID = window.setTimeout(scheduler, lookahead);
        }

        function playNote() {
            // play the note
            oscillator.start(0);
            oscillator.stop(noteLength);
        }

        function startMetronome() {
            if (!isPlaying) {
                // start playing
                current16thNote = 0;
                nextNoteTime = audioContext.currentTime;
                scheduler(); // kick off scheduling
                isPlaying = !isPlaying;
            }
        }

        function stopMetronome() {
            if (isPlaying) {
                window.clearTimeout(timerID);
                isPlaying = !isPlaying;
            }
        }

        function adjustBpm() {
            tempo = document.getElementById("bpm").value;
        }
    </script>
</body>

</html>